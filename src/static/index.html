<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üåû Solar Forecast ‚Äî —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞</title>

<!-- Tailwind Play CDN (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞, –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –ª—É—á—à–µ —Å–æ–±—Ä–∞—Ç—å Tailwind) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

<style>
html,body,#app { height: 100%; }
/* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.toast-enter { transform: translateY(-8px); opacity: 0; }
.toast-enter-active { transform: translateY(0); opacity: 1; transition: all .28s ease; }
.toast-exit { opacity: 1; }
.toast-exit-active { opacity: 0; transition: opacity .28s ease; }
/* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –ø–∞–Ω–µ–ª–∏ –æ—Ç–ª–∞–¥–∫–∏ */
#debug-output { max-height: 180px; overflow-y: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace; font-size: 12px; }
</style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-slate-900 to-black text-slate-100">
<div id="app" class="min-h-screen p-6">

  <header class="max-w-7xl mx-auto mb-6">
    <div class="flex items-center justify-between gap-6">
      <div>
        <h1 class="text-3xl font-extralight">üåû <span class="font-medium">Solar Insolation Forecast</span></h1>
        <p class="text-slate-400 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ ‚Äî –ø–æ–ª—É—á–∞–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é, ML-–ø—Ä–æ–≥–Ω–æ–∑, —Å–∫–∞—á–∏–≤–∞–π—Ç–µ Excel –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</p>
      </div>

      <div class="flex items-center gap-3">
        <button id="export-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-sm font-medium shadow">
          üíæ –°–∫–∞—á–∞—Ç—å Excel
        </button>
        <div id="status-badge" class="px-3 py-2 rounded bg-slate-800 text-slate-300 text-sm">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–Ω–∏–µ</div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto grid grid-cols-12 gap-6">
    <!-- Map + info -->
    <section class="col-span-12 lg:col-span-5 bg-slate-800 rounded-lg p-4 border border-slate-700 shadow-inner">
      <h2 class="text-lg font-medium mb-3 text-slate-100">üó∫Ô∏è –í—ã–±–æ—Ä –ª–æ–∫–∞—Ü–∏–∏</h2>
      <div id="map" class="w-full h-96 rounded-md border border-slate-700"></div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <div class="bg-slate-900 p-3 rounded border border-slate-700">
          <div class="text-xs text-slate-400">–®–∏—Ä–æ—Ç–∞</div>
          <div id="lat-value" class="text-lg font-medium">-</div>
        </div>
        <div class="bg-slate-900 p-3 rounded border border-slate-700">
          <div class="text-xs text-slate-400">–î–æ–ª–≥–æ—Ç–∞</div>
          <div id="lng-value" class="text-lg font-medium">-</div>
        </div>
      </div>

      <div class="mt-4 bg-slate-900 p-3 rounded border border-slate-700">
        <div class="text-xs text-slate-400">–°—Ç–∞—Ç—É—Å</div>
        <div id="status" class="text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</div>
      </div>

      <div class="mt-4 bg-slate-900 p-3 rounded border border-slate-700">
        <div class="text-xs text-slate-400">–û—Ç–ª–∞–¥–∫–∞</div>
        <div id="debug-output" class="mt-2 text-slate-200">–ñ–¥–µ–º –¥–µ–π—Å—Ç–≤–∏—è...</div>
      </div>
    </section>

    <!-- Charts -->
    <section class="col-span-12 lg:col-span-7 bg-slate-800 rounded-lg p-4 border border-slate-700">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-medium">üìä –ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</h2>
        <div class="text-sm text-slate-400">–ü–æ–∫–∞–∑–∞–Ω—ã: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 48 —á + –ø—Ä–æ–≥–Ω–æ–∑</div>
      </div>

      <div id="loading" class="hidden mb-4">
        <div class="flex items-center gap-3 px-3 py-2 rounded bg-slate-900 border border-slate-700">
          <div class="w-6 h-6 border-4 border-t-4 border-slate-600 rounded-full animate-spin"></div>
          <div class="text-slate-300">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç—Ä–æ–∏–º –ø—Ä–æ–≥–Ω–æ–∑...</div>
        </div>
      </div>

      <div id="error-message" class="hidden mb-4 text-sm bg-rose-900 text-rose-100 px-3 py-2 rounded border border-rose-700"></div>

      <!-- Tabs -->
      <div id="tabs" class="flex gap-2 overflow-x-auto pb-2 mb-4 border-b border-slate-700"></div>

      <!-- Plot container -->
      <div id="plot-container" class="space-y-6"></div>
    </section>
  </main>

  <!-- Toast notifications -->
  <div id="toasts" class="fixed top-6 right-6 w-80 space-y-3 z-50"></div>

  <!-- Footer small -->
  <footer class="max-w-7xl mx-auto mt-8 text-slate-500 text-sm">
    <div>Backend: <code class="bg-slate-900 px-2 py-0.5 rounded">/api/v1/forecast</code>, WebSocket: <code class="bg-slate-900 px-2 py-0.5 rounded">/api/v1/ws/solar</code></div>
  </footer>
</div>

<script>
/* ========= –£—Ç–∏–ª–∏—Ç—ã –∏ UI helpers ========= */
function debugLog(msg) {
  const out = document.getElementById('debug-output');
  const ts = new Date().toLocaleTimeString();
  out.innerHTML = '['+ts+'] ' + msg + '<br>' + out.innerHTML;
  console.log('[DEBUG]', msg);
}

function showToast(message, level='info', timeout=4500) {
  const container = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = 'rounded p-3 shadow-lg border ' + (level==='error' ? 'bg-rose-600 border-rose-700 text-white' : (level==='warn' ? 'bg-amber-600 border-amber-700 text-slate-900' : 'bg-slate-900 border-slate-700 text-slate-100'));
  t.textContent = message;
  container.appendChild(t);
  setTimeout(()=>{ t.classList.add('fade'); try{ container.removeChild(t);}catch(e){} }, timeout);
}

/* ========= WebSocket with reconnection ========= */
let ws = null;
let wsRetry = 0;
function connectWS() {
  const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
  const url = `${scheme}://${location.host}/api/v1/ws/solar`;
  debugLog('–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket...');
  try {
    ws = new WebSocket(url);
  } catch (e) {
    debugLog('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket: ' + e.message);
    scheduleReconnect();
    return;
  }

  ws.addEventListener('open', () => {
    debugLog('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
    wsRetry = 0;
    showToast('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'info', 2000);
    const statusBadge = document.getElementById('status-badge');
    statusBadge.textContent = '–°—Ç–∞—Ç—É—Å: WS –ø–æ–¥–∫–ª—é—á–µ–Ω';
    statusBadge.classList.remove('bg-red-800'); statusBadge.classList.add('bg-slate-800');
  });

  ws.addEventListener('message', (ev) => {
    debugLog('üì® WS: ' + ev.data);
    showToast(ev.data, 'warn', 6000);
  });

  ws.addEventListener('close', (ev) => {
    debugLog(`‚ö† WebSocket –∑–∞–∫—Ä—ã—Ç (–∫–æ–¥=${ev.code})`);
    scheduleReconnect();
  });

  ws.addEventListener('error', (ev) => {
    debugLog('‚ùå WebSocket –æ—à–∏–±–∫–∞: ' + String(ev));
    try { ws.close(); } catch(e){}
    scheduleReconnect();
  });
}

function scheduleReconnect() {
  wsRetry++;
  const wait = Math.min(30000, 1000 * Math.pow(1.8, wsRetry)); // —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
  debugLog(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ ${Math.round(wait/1000)} —Å...`);
  const statusBadge = document.getElementById('status-badge');
  statusBadge.textContent = '–°—Ç–∞—Ç—É—Å: WS –æ—Ç–∫–ª—é—á–µ–Ω ‚Äî –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
  statusBadge.classList.add('bg-red-800');
  setTimeout(connectWS, wait);
}

// —Å—Ç–∞—Ä—Ç—É–µ–º ws
connectWS();

/* ========= Map init ========= */
const map = L.map('map').setView([55.7558, 37.6173], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

let marker = null;
let currentLatLng = null;

map.on('click', onMapClick);

/* ========= DOM references ========= */
const loadingEl = document.getElementById('loading');
const errorEl = document.getElementById('error-message');
const plotContainer = document.getElementById('plot-container');
const tabsContainer = document.getElementById('tabs');
const latValue = document.getElementById('lat-value');
const lngValue = document.getElementById('lng-value');
const statusEl = document.getElementById('status');
const exportBtn = document.getElementById('export-btn');

/* ========= Plot helpers ========= */
function safeTitleFromLayout(layoutTitle) {
  // –µ—Å–ª–∏ –µ—Å—Ç—å –¥–≤–æ–µ—Ç–æ—á–∏–µ, –±–µ—Ä–µ–º —á–∞—Å—Ç—å –ø–æ—Å–ª–µ –Ω–µ–≥–æ, –∏–Ω–∞—á–µ –≤—Å—é —Å—Ç—Ä–æ–∫—É
  if (!layoutTitle && layoutTitle !== '') return '–ì—Ä–∞—Ñ–∏–∫';
  if (typeof layoutTitle !== 'string') return String(layoutTitle);
  const idx = layoutTitle.indexOf(':');
  return idx >= 0 ? layoutTitle.slice(idx + 1).trim() : layoutTitle;
}

function clearPlots() {
  plotContainer.innerHTML = '';
  tabsContainer.innerHTML = '';
}

function renderMultiplePlots(plotArray) {
  try {
    if (!Array.isArray(plotArray) || plotArray.length === 0) throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤');
    clearPlots();

    plotArray.forEach((plotData, index) => {
      const rawTitle = (plotData && plotData.layout && plotData.layout.title) ? plotData.layout.title : (`–ì—Ä–∞—Ñ–∏–∫ ${index+1}`);
      const title = safeTitleFromLayout(rawTitle);

      // tab button
      const tab = document.createElement('button');
      tab.className = 'tab px-3 py-1 rounded-t-md bg-slate-700 hover:bg-slate-600 text-sm';
      tab.textContent = title;
      tab.dataset.index = index;
      tabsContainer.appendChild(tab);

      // chart box
      const box = document.createElement('div');
      box.className = 'chart-box tab-content hidden bg-slate-900 p-3 rounded border border-slate-700';
      box.id = `plotly-graph-${index}`;
      plotContainer.appendChild(box);

      // create plot
      try {
        Plotly.newPlot(box.id, plotData.traces, plotData.layout, { responsive: true, displayModeBar: true, displaylogo: false })
          .then(() => {
            debugLog(`‚úÖ –ì—Ä–∞—Ñ–∏–∫ "${title}" –ø–æ—Å—Ç—Ä–æ–µ–Ω`);
          })
          .catch(err => {
            debugLog(`‚ùå –û—à–∏–±–∫–∞ Plotly –¥–ª—è "${title}": ${err.message || err}`);
          });
      } catch (e) {
        debugLog('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ' + e.message);
      }

      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('bg-emerald-500', 'text-black'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('bg-emerald-500', 'text-black');
        box.classList.remove('hidden');
      });
    });

    // –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞–±
    const firstTab = tabsContainer.querySelector('.tab');
    if (firstTab) firstTab.click();

    statusEl.textContent = '–ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã';
    statusEl.classList.remove('text-amber-400');
    statusEl.classList.add('text-emerald-400');
    debugLog(`–ü–æ–ª—É—á–µ–Ω–æ –≥—Ä–∞—Ñ–∏–∫–æ–≤: ${plotArray.length}`);
  } catch (err) {
    plotContainer.innerHTML = `<div class="p-6 text-rose-200 bg-rose-900 rounded">${err.message}</div>`;
    debugLog('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤: ' + err.message);
    throw err;
  }
}

/* ========= API calls ========= */
async function requestForecast(lat, lng) {
  showLoading();
  hideError();
  statusEl.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';
  statusEl.classList.remove('text-emerald-400'); statusEl.classList.add('text-amber-400');

  try {
    const payload = { latitude: lat, longitude: lng, use_ml: true };
    const res = await fetch('/api/v1/forecast', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    debugLog(`–û—Ç–≤–µ—Ç API: ${res.status} ${res.statusText}`);
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`HTTP ${res.status} - ${txt}`);
    }
    const data = await res.json();

    if (!data.plot_data || !Array.isArray(data.plot_data)) {
      throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è plot_data');
    }

    // build and render
    renderMultiplePlots(data.plot_data);

    // put status and show brief metrics
    if (data.metrics) {
      debugLog(`–ú–µ—Ç—Ä–∏–∫–∏: MSE=${data.metrics.mse}, MAE=${data.metrics.mae}, R2=${data.metrics.r2}`);
      showToast(`–ú–µ—Ç—Ä–∏–∫–∏: MSE=${(data.metrics.mse||0).toFixed(2)}, MAE=${(data.metrics.mae||0).toFixed(2)}, R¬≤=${(data.metrics.r2||0).toFixed(2)}`, 'info', 5000);
    }

  } catch (err) {
    showError(err.message || String(err));
    debugLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + (err.message || err));
  } finally {
    hideLoading();
  }
}

function showLoading(){ loadingEl.classList.remove('hidden'); }
function hideLoading(){ loadingEl.classList.add('hidden'); }
function showError(msg){ errorEl.textContent = msg; errorEl.classList.remove('hidden'); statusEl.textContent = '–û—à–∏–±–∫–∞'; statusEl.classList.add('text-rose-400'); }
function hideError(){ errorEl.classList.add('hidden'); }

/* ========= Map click handler ========= */
function onMapClick(e) {
  currentLatLng = e.latlng;
  if (marker) map.removeLayer(marker);
  marker = L.marker(currentLatLng).addTo(map);

  latValue.textContent = currentLatLng.lat.toFixed(6);
  lngValue.textContent = currentLatLng.lng.toFixed(6);

  debugLog(`üì° –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: ${currentLatLng.lat}, ${currentLatLng.lng}`);
  requestForecast(currentLatLng.lat, currentLatLng.lng);
}

/* ========= Export Excel ========= */
exportBtn.addEventListener('click', async () => {
  if (!currentLatLng) {
    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ!');
    return;
  }
  showLoading();
  try {
    const res = await fetch('/api/v1/forecast/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ latitude: currentLatLng.lat, longitude: currentLatLng.lng })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`–û—à–∏–±–∫–∞ ${res.status}: ${text}`);
    }

    // –ü–æ–ª—É—á–∞–µ–º blob
    const blob = await res.blob();
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    let filename = `solar_forecast_${currentLatLng.lat}_${currentLatLng.lng}.xlsx`;
    const cd = res.headers.get('content-disposition');
    if (cd) {
      const m = cd.match(/filename\*=UTF-8''(.+)|filename="(.+)"|filename=(.+)/i);
      if (m) {
        filename = decodeURIComponent(m[1] || m[2] || m[3]);
      }
    }

    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
    showToast('Excel —Å–∫–∞—á–∞–Ω', 'info', 3000);
    debugLog('Excel —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω: ' + filename);
  } catch (err) {
    debugLog('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ Excel: ' + (err.message || err));
    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ Excel: ' + (err.message || err), 'error', 6000);
  } finally {
    hideLoading();
  }
});

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */
debugLog('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ');
</script>
</body>
</html>
